#!/usr/bin/env python3
"""weather â€” script plugin for oh-my-claude.

Shows current weather in the statusline. Uses wttr.in (no API key needed).
"""

import json
import sys
import urllib.request
import urllib.error

CONDITION_ICONS = {
    "113": "â˜€ï¸",   # Clear/Sunny
    "116": "â›…",   # Partly cloudy
    "119": "â˜ï¸",   # Cloudy
    "122": "â˜ï¸",   # Overcast
    "143": "ğŸŒ«ï¸",  # Mist
    "176": "ğŸŒ¦ï¸",  # Patchy rain
    "179": "ğŸŒ¨ï¸",  # Patchy snow
    "182": "ğŸŒ§ï¸",  # Patchy sleet
    "185": "ğŸŒ§ï¸",  # Patchy freezing drizzle
    "200": "â›ˆï¸",   # Thundery outbreaks
    "227": "ğŸŒ¨ï¸",  # Blowing snow
    "230": "â„ï¸",   # Blizzard
    "248": "ğŸŒ«ï¸",  # Fog
    "260": "ğŸŒ«ï¸",  # Freezing fog
    "263": "ğŸŒ¦ï¸",  # Patchy light drizzle
    "266": "ğŸŒ§ï¸",  # Light drizzle
    "281": "ğŸŒ§ï¸",  # Freezing drizzle
    "284": "ğŸŒ§ï¸",  # Heavy freezing drizzle
    "293": "ğŸŒ¦ï¸",  # Patchy light rain
    "296": "ğŸŒ§ï¸",  # Light rain
    "299": "ğŸŒ§ï¸",  # Moderate rain at times
    "302": "ğŸŒ§ï¸",  # Moderate rain
    "305": "ğŸŒ§ï¸",  # Heavy rain at times
    "308": "ğŸŒ§ï¸",  # Heavy rain
    "311": "ğŸŒ§ï¸",  # Light freezing rain
    "314": "ğŸŒ§ï¸",  # Moderate/heavy freezing rain
    "317": "ğŸŒ¨ï¸",  # Light sleet
    "320": "ğŸŒ¨ï¸",  # Moderate/heavy sleet
    "323": "ğŸŒ¨ï¸",  # Patchy light snow
    "326": "ğŸŒ¨ï¸",  # Light snow
    "329": "ğŸŒ¨ï¸",  # Patchy moderate snow
    "332": "ğŸŒ¨ï¸",  # Moderate snow
    "335": "â„ï¸",   # Patchy heavy snow
    "338": "â„ï¸",   # Heavy snow
    "350": "ğŸŒ§ï¸",  # Ice pellets
    "353": "ğŸŒ¦ï¸",  # Light rain shower
    "356": "ğŸŒ§ï¸",  # Moderate/heavy rain shower
    "359": "ğŸŒ§ï¸",  # Torrential rain shower
    "362": "ğŸŒ¨ï¸",  # Light sleet showers
    "365": "ğŸŒ¨ï¸",  # Moderate/heavy sleet showers
    "368": "ğŸŒ¨ï¸",  # Light snow showers
    "371": "â„ï¸",   # Moderate/heavy snow showers
    "374": "ğŸŒ§ï¸",  # Light ice pellet showers
    "377": "ğŸŒ§ï¸",  # Moderate/heavy ice pellet showers
    "386": "â›ˆï¸",   # Patchy light rain with thunder
    "389": "â›ˆï¸",   # Moderate/heavy rain with thunder
    "392": "â›ˆï¸",   # Patchy light snow with thunder
    "395": "â›ˆï¸",   # Moderate/heavy snow with thunder
}


def main():
    try:
        data = json.load(sys.stdin)
    except (json.JSONDecodeError, EOFError):
        sys.exit(1)

    config = data.get("_config", {})
    location = config.get("location", "")  # empty = auto-detect by IP
    units = config.get("units", "f")  # "f" for Fahrenheit, "c" for Celsius

    url = f"https://wttr.in/{urllib.request.quote(location)}?format=j1"
    try:
        req = urllib.request.Request(url, headers={"User-Agent": "omc-plugin-weather"})
        with urllib.request.urlopen(req, timeout=3) as resp:
            weather = json.loads(resp.read())
    except (urllib.error.URLError, OSError, json.JSONDecodeError, KeyError):
        sys.exit(1)

    try:
        current = weather["current_condition"][0]
        code = current.get("weatherCode", "")
        icon = CONDITION_ICONS.get(code, "ğŸŒ¡ï¸")

        if units == "c":
            temp = current.get("temp_C", "?")
            unit_symbol = "Â°C"
        else:
            temp = current.get("temp_F", "?")
            unit_symbol = "Â°F"

        area = weather.get("nearest_area", [{}])[0]
        city = area.get("areaName", [{}])[0].get("value", "")

        text = f"{icon} {temp}{unit_symbol}"
        if config.get("showCity", False) and city:
            text += f" {city}"

        json.dump({"text": text, "style": config.get("style", "cyan")}, sys.stdout)
    except (KeyError, IndexError):
        sys.exit(1)


if __name__ == "__main__":
    main()
