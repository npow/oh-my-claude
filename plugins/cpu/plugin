#!/usr/bin/env python3
"""cpu — oh-my-claude plugin. Shows CPU usage percentage.

macOS: uses top -l 1.
Linux: reads /proc/stat.
"""

import json
import platform
import subprocess
import sys
from pathlib import Path


def get_cpu_macos():
    try:
        result = subprocess.run(
            ["top", "-l", "1", "-n", "0", "-s", "0"],
            capture_output=True, text=True, timeout=3,
        )
        for line in result.stdout.splitlines():
            if "CPU usage" in line:
                # "CPU usage: 12.5% user, 8.3% sys, 79.1% idle"
                for part in line.split(","):
                    if "idle" in part:
                        idle = float(part.strip().split("%")[0].strip().split()[-1])
                        return round(100 - idle)
    except (subprocess.TimeoutExpired, FileNotFoundError, ValueError):
        pass
    return None


# Cache previous /proc/stat read for delta calculation
_prev_idle = None
_prev_total = None


def get_cpu_linux():
    global _prev_idle, _prev_total
    try:
        stat = Path("/proc/stat").read_text()
        for line in stat.splitlines():
            if line.startswith("cpu "):
                values = [int(x) for x in line.split()[1:]]
                idle = values[3]
                total = sum(values)

                if _prev_idle is not None and _prev_total is not None:
                    diff_idle = idle - _prev_idle
                    diff_total = total - _prev_total
                    if diff_total > 0:
                        usage = round(100 * (1 - diff_idle / diff_total))
                    else:
                        usage = 0
                else:
                    # First read — approximate from cumulative
                    usage = round(100 * (1 - idle / total)) if total > 0 else 0

                _prev_idle = idle
                _prev_total = total
                return usage
    except (FileNotFoundError, ValueError):
        pass
    return None


def main():
    try:
        data = json.load(sys.stdin)
    except (json.JSONDecodeError, EOFError):
        sys.exit(1)

    config = data.get("_config", {})
    style = config.get("style", "white")
    style_warn = config.get("styleWarn", "yellow")
    style_critical = config.get("styleCritical", "bold red")
    warn_at = config.get("warnAt", 70)
    critical_at = config.get("criticalAt", 90)

    system = platform.system()
    if system == "Darwin":
        usage = get_cpu_macos()
    elif system == "Linux":
        usage = get_cpu_linux()
    else:
        sys.exit(1)

    if usage is None:
        sys.exit(1)

    if usage >= critical_at:
        active_style = style_critical
    elif usage >= warn_at:
        active_style = style_warn
    else:
        active_style = style

    json.dump({"text": f"cpu {usage}%", "style": active_style}, sys.stdout)


if __name__ == "__main__":
    main()
