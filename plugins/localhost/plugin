#!/usr/bin/env python3
"""localhost â€” oh-my-claude plugin. Checks if a local port is responding."""

import json
import socket
import sys


def check_port(host, port, timeout):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        result = sock.connect_ex((host, port))
        sock.close()
        return result == 0
    except (socket.error, OSError):
        return False


def main():
    try:
        data = json.load(sys.stdin)
    except (json.JSONDecodeError, EOFError):
        sys.exit(1)

    config = data.get("_config", {})
    port = config.get("port", 3000)
    host = config.get("host", "127.0.0.1")
    timeout = config.get("timeout", 0.5)
    label = config.get("label", "")
    style_up = config.get("styleUp", "green")
    style_down = config.get("styleDown", "bold red")

    up = check_port(host, port, timeout)

    display = label or f":{port}"
    if up:
        json.dump({"text": f"\u25cf {display}", "style": style_up}, sys.stdout)
    else:
        json.dump({"text": f"\u25cb {display}", "style": style_down}, sys.stdout)


if __name__ == "__main__":
    main()
